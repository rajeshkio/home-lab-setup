apiVersion: batch/v1
kind: Job
metadata:
  name: vault-config
  namespace: vault
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  template:
    spec:
      containers:
      - name: vault-config
        image: hashicorp/vault:1.19
        env:
        - name: VAULT_PREFIX
          value: "rancher-master"
        command:
        - /bin/sh
        - -c
        - |
          # Wait for init job to complete
          while [ ! -f /vault-keys/root-token.txt ]; do
            echo "Waiting for initialization to complete..."
            sleep 5
          done
          
          # Get root token
          ROOT_TOKEN=$(cat /vault-keys/root-token.txt)
          
          # Login
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault login $ROOT_TOKEN
          
          # Enable KV v2 secrets engine for certificates
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault secrets enable -path=certificates -version=2 kv || true
          
          # Enable Kubernetes auth
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault auth enable --path ${VAULT_PREFIX} kubernetes || true
          
          # Configure Kubernetes auth
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault write auth/${VAULT_PREFIX}/config \
            kubernetes_host="https://kubernetes.default.svc" \
            kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
            token_reviewer_jwt=@/var/run/secrets/kubernetes.io/serviceaccount/token \
            disable_iss_validation=true
          
          # Create cert-pusher policy
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault policy write cert-pusher - <<EOF
          path "certificates/data/tls/*" {
            capabilities = ["create", "update", "read"]
          }
          path "certificates/metadata/tls/*" {
            capabilities = ["read", "list"]
          }
          EOF
          
          # Create cert-reader policy
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault policy write cert-reader - <<EOF
          path "certificates/data/tls/*" {
            capabilities = ["read"]
          }
          path "certificates/metadata/tls/*" {
            capabilities = ["read", "list"]
          }
          EOF
          
          # Create cert-pusher role
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault write auth/${VAULT_PREFIX}/role/cert-pusher \
            bound_service_account_names=cert-pusher \
            bound_service_account_namespaces=cert-manager \
            policies=cert-pusher \
            ttl=24h \
            max_ttl=48h \
            audience=vault
          
          # Create cert-reader role
          VAULT_ADDR=http://${VAULT_PREFIX}-vault.vault.svc.cluster.local:8200 vault write auth/${VAULT_PREFIX}/role/cert-reader \
            bound_service_account_names=external-secrets \
            bound_service_account_namespaces=external-secrets \
            policies=cert-reader \
            ttl=24h \
            max_ttl=48h \
            audience=vault
          
          echo "Vault configuration complete!"
        volumeMounts:
        - name: vault-keys
          mountPath: /vault-keys
      volumes:
      - name: vault-keys
        persistentVolumeClaim:
          claimName: vault-keys
      restartPolicy: OnFailure
      serviceAccountName: vault-config
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-config
  namespace: vault
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-config-role
  namespace: vault
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-config-rolebinding
  namespace: vault
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-config-role
subjects:
- kind: ServiceAccount
  name: vault-config
  namespace: vault
